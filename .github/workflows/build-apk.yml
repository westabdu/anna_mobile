name: Build ANNA Mobile APK

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      version:
        description: 'APK Versiyonu'
        required: false
        default: '0.4'
        type: string

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'  # Otomatik cache
          
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'
          
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.3'
          channel: 'stable'
          cache: true
          
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgl1-mesa-glx \
            libglib2.0-0 \
            libsm6 \
            libxext6 \
            libxrender-dev \
            libgomp1 \
            tesseract-ocr \
            tesseract-ocr-tur \
            portaudio19-dev \
            libsndfile1 \
            libsdl2-dev \
            cmake \
            ninja-build \
            pkg-config
          
      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install setuptools wheel
          # NumPy'i önce yükle (bağımlılık sırası önemli)
          pip install numpy==1.24.3
          # Diğer paketleri yükle
          pip install -r requirements.txt
          
      - name: Create .env file from secrets
        run: |
          cat > .env << EOF
          GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}
          GROQ_API_KEY=${{ secrets.GROQ_API_KEY }}
          OPENWEATHER_API_KEY=${{ secrets.OPENWEATHER_API_KEY }}
          NEWS_API_KEY=${{ secrets.NEWS_API_KEY }}
          PICOVOICE_ACCESS_KEY=${{ secrets.PICOVOICE_ACCESS_KEY }}
          EOF
          
      - name: Verify Flutter & Flet
        run: |
          flutter doctor
          pip show flet
          
      - name: Build APK
        run: |
          flet build apk . \
            --build-number ${{ github.run_number }} \
            --build-version "${{ github.event.inputs.version || '0.4' }}.${{ github.run_number }}"
          
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: ANNA-Mobile-${{ github.event.inputs.version || '0.4' }}.${{ github.run_number }}
          path: build/apk/*.apk
          retention-days: 30
          
      - name: Create Release
        if: github.ref == 'refs/heads/main'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ github.event.inputs.version || '0.4' }}.${{ github.run_number }}
          name: A.N.N.A Mobile v${{ github.event.inputs.version || '0.4' }}.${{ github.run_number }}
          files: build/apk/*.apk
          generate_release_notes: true